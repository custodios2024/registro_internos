<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Internos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <!-- Cargar la API de Google -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        h2 { text-align: center; margin-top: 60px; }
        h3 { text-align: center; margin-top: 20px; }
        label { font-weight: bold; }
        input, button, select { width: 100%; margin-bottom: 10px; padding: 10px; }
        .btn { background-color: #007bff; color: white; border: none; cursor: pointer; }
        .btn:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <img src="logo_sspc2.png" alt="Logo SSPC" style="display: block; margin: auto; width: 100px; height: auto;">
        <h2>Registro de Internos</h2>
        
        <button class="btn" id="authorize_button" style="display: none;">Autorizar Google Drive</button>
        <button class="btn" id="signout_button" style="display: none;">Cerrar sesión</button>
        
        <form id="registroForm">
            <!-- Aquí va tu formulario -->
        </form>

        <button type="button" class="btn" onclick="exportarPDF()">Guardar PDF del Día</button>
    </div>

    <script>
        // Cargar las credenciales de OAuth
        const CLIENT_ID = '982226404755-8cpgjvkba74miq0aljgt9i9pp7278p3m.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD1d3Un7HltXCFk_WssjyYmZabH0JRxACM';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/drive.file";

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Cargar la biblioteca de Google API
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // Inicializar el cliente GAPI
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        // Cargar la API del servicio de identidad de Google (GIS)
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Autorización de OAuth 2.0 completada
            });
            gisInited = true;
            maybeEnableButtons();
        }

        // Habilitar los botones de inicio de sesión/cierre de sesión si el cliente GAPI y GIS están inicializados
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.display = 'block';
            }
        }

        // Manejar el botón de autorización de Google
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('signout_button').style.display = 'block';
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        // Manejar el cierre de sesión de Google
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken(null);
                document.getElementById('signout_button').style.display = 'none';
            }
        }

        // Generar el PDF y subirlo a Google Drive
        async function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Generar tu contenido del PDF
            doc.text("Registro del Día", 140, 20, { align: 'center' });
            doc.autoTable({
                head: [['Fecha', 'Hora', 'Motivo', 'Excarcelados (H)', 'Excarcelados (M)', 'Presentes (H)', 'Presentes (M)', 'Total', 'Custodio Responsable', 'Personal de la D.G.R.S.']],
                body: [
                    // Aquí puedes agregar los datos del registro
                ],
                startY: 40,
                margin: { top: 40 },
            });

            // Guardar el PDF en una variable blob
            const pdfBlob = doc.output('blob');

            // Crear un archivo en Google Drive
            const metadata = {
                name: 'registro_del_dia.pdf',
                mimeType: 'application/pdf',
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', pdfBlob);

            const accessToken = gapi.auth.getToken().access_token;
            const uploadUrl = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

            // Subir el PDF a Google Drive
            const response = await fetch(uploadUrl, {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form,
            });

            const file = await response.json();
            alert(`PDF subido a Google Drive con ID: ${file.id}`);
        }

        // Cargar las funciones necesarias para Google API
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('authorize_button').addEventListener('click', handleAuthClick);
            document.getElementById('signout_button').addEventListener('click', handleSignoutClick);

            // Cargar scripts de Google API y GIS
            gapiLoaded();
            gisLoaded();
        });
    </script>
    <script src="https://apis.google.com/js/api.js?onload=gapiLoaded"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</body>
</html>
