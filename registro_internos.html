<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Internos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <!-- Cargar la API de Google -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        h2 { text-align: center; margin-top: 60px; }
        h3 { text-align: center; margin-top: 20px; }
        label { font-weight: bold; }
        input, button, select { width: 100%; margin-bottom: 10px; padding: 10px; }
        .btn { background-color: #007bff; color: white; border: none; cursor: pointer; }
        .btn:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <img src="logo_sspc2.png" alt="Logo SSPC" style="display: block; margin: auto; width: 100px; height: auto;">
        <h2>Registro de Internos</h2>
        
        <button class="btn" id="authorize_button" style="display: none;">Autorizar Google Drive</button>
        <button class="btn" id="signout_button" style="display: none;">Cerrar sesión</button>
        
        <form id="registroForm">
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" name="fecha" required>

            <label for="hora">Hora:</label>
            <input type="time" id="hora" name="hora" required>

            <label for="motivo">Motivo:</label>
            <input type="text" id="motivo" name="motivo" required>

            <label for="excarceladosH">Excarcelados Hombres:</label>
            <input type="number" id="excarceladosH" name="excarceladosH" required>

            <label for="excarceladosM">Excarcelados Mujeres:</label>
            <input type="number" id="excarceladosM" name="excarceladosM" required>

            <label for="presentesH">Presentes Hombres:</label>
            <input type="number" id="presentesH" name="presentesH" required>

            <label for="presentesM">Presentes Mujeres:</label>
            <input type="number" id="presentesM" name="presentesM" required>

            <label for="custodio">Custodio Responsable:</label>
            <input type="text" id="custodio" name="custodio" required>

            <label for="personal">Personal de la D.G.R.S.:</label>
            <input type="text" id="personal" name="personal" required>

            <button type="button" class="btn" onclick="exportarPDF()">Guardar PDF del Día</button>
        </form>
    </div>

    <script>
        const CLIENT_ID = '982226404755-8cpgjvkba74miq0aljgt9i9pp7278p3m.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD1d3Un7HltXCFk_WssjyYmZabH0JRxACM';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/drive.file";

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.display = 'block';
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('signout_button').style.display = 'block';
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken(null);
                document.getElementById('signout_button').style.display = 'none';
            }
        }

        async function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            const fecha = document.getElementById('fecha').value;
            const hora = document.getElementById('hora').value;
            const motivo = document.getElementById('motivo').value;
            const excarceladosH = document.getElementById('excarceladosH').value;
            const excarceladosM = document.getElementById('excarceladosM').value;
            const presentesH = document.getElementById('presentesH').value;
            const presentesM = document.getElementById('presentesM').value;
            const custodio = document.getElementById('custodio').value;
            const personal = document.getElementById('personal').value;

            doc.text("Registro del Día", 140, 20, { align: 'center' });
            doc.autoTable({
                head: [['Fecha', 'Hora', 'Motivo', 'Excarcelados (H)', 'Excarcelados (M)', 'Presentes (H)', 'Presentes (M)', 'Custodio Responsable', 'Personal de la D.G.R.S.']],
                body: [
                    [fecha, hora, motivo, excarceladosH, excarceladosM, presentesH, presentesM, custodio, personal]
                ],
                startY: 40,
                margin: { top: 40 },
            });

            const pdfBlob = doc.output('blob');

            const metadata = {
                name: 'registro_del_dia.pdf',
                mimeType: 'application/pdf',
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', pdfBlob);

            const accessToken = gapi.auth.getToken().access_token;
            const uploadUrl = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

            const response = await fetch(uploadUrl, {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form,
            });

            const file = await response.json();
            alert(`PDF subido a Google Drive con ID: ${file.id}`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('authorize_button').addEventListener('click', handleAuthClick);
            document.getElementById('signout_button').addEventListener('click', handleSignoutClick);

            gapiLoaded();
            gisLoaded();
        });
    </script>
    <script src="https://apis.google.com/js/api.js?onload=gapiLoaded"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</body>
</html>
