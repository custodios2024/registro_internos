<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Internos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        h2 { text-align: center; margin-top: 20px; }
        h3 { text-align: center; margin-top: 20px; }
        label { font-weight: bold; }
        input, button, select { width: 100%; margin-bottom: 10px; padding: 10px; }
        .btn { background-color: #007bff; color: white; border: none; cursor: pointer; }
        .btn:hover { background-color: #0056b3; }
        .output { white-space: pre-wrap; background-color: #f9f9f9; padding: 10px; border-radius: 5px; }
        .record-list { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; margin-top: 20px; padding: 10px; }
        .select-container { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Registro de Internos</h2>
        <label for="fecha">Selecciona la fecha del registro:</label>
        <input type="date" id="fecha">

        <button class="btn" onclick="exportarPDF()">Guardar PDF del Día</button>
        <button class="btn" onclick="exportarPDFCompleto()">Guardar PDF Completo</button>
    </div>

    <script>
        // Variables de Google API
        let gapiIniciado = false;
        let googleAutorizado = false;

        // Cargar la API de Google
        function cargarApiGoogle() {
            gapi.load('client:auth2', iniciarClienteGoogle);
        }

        // Inicializar cliente Google API
        function iniciarClienteGoogle() {
            gapi.client.init({
                apiKey: 'YOUR_API_KEY', // Inserta tu API Key
                clientId: '982226404755-8cpgjvkba74miq0aljgt9i9pp7278p3m.apps.googleusercontent.com',
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                scope: 'https://www.googleapis.com/auth/drive.file'
            }).then(() => {
                gapiIniciado = true;
                verificarInicioSesion();
            }, (error) => {
                console.error("Error al iniciar cliente Google API:", error);
            });
        }

        // Verificar si el usuario está autorizado
        function verificarInicioSesion() {
            const GoogleAuth = gapi.auth2.getAuthInstance();
            googleAutorizado = GoogleAuth.isSignedIn.get();
            if (!googleAutorizado) {
                GoogleAuth.signIn();
            }
        }

        // Función para subir el PDF a Google Drive
        function subirPDFaDrive(pdfBlob, nombreArchivo) {
            const fileMetadata = {
                'name': nombreArchivo,
                'mimeType': 'application/pdf'
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
            form.append('file', pdfBlob);

            gapi.client.request({
                path: 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`,
                },
                body: form
            }).then((response) => {
                console.log('Archivo subido con éxito:', response);
                alert('El archivo se ha subido correctamente a Google Drive.');
            }, (error) => {
                console.error("Error al subir el archivo a Drive:", error);
                alert('Hubo un error al subir el archivo a Google Drive.');
            });
        }

        // Función para descargar el PDF del día
        function exportarPDF() {
            const doc = new jsPDF();
            doc.text("Registro Completo", 14, 22);
            const records = JSON.parse(localStorage.getItem('registrosPorFecha')) || {};
            const fecha = document.getElementById('fecha').value;
            const registros = records[fecha] || [];

            const tableData = registros.map((registro) => [
                registro.fecha,
                registro.hora,
                registro.motivo,
                registro.excarceladosH,
                registro.excarceladosM,
                registro.presentesH,
                registro.presentesM,
                registro.total
            ]);

            doc.autoTable({
                head: [['Fecha', 'Hora', 'Motivo', 'Excarcelados (H)', 'Excarcelados (M)', 'Presentes (H)', 'Presentes (M)', 'Total']],
                body: tableData,
            });
            doc.save(`Registro_Internos_${fecha}.pdf`);
        }

        // Función para guardar el PDF completo en Google Drive
        function exportarPDFCompleto() {
            const doc = new jsPDF();
            doc.text("Registro Completo", 14, 22);
            const records = JSON.parse(localStorage.getItem('registrosPorFecha')) || {};

            const tableData = Object.entries(records).flatMap(([fecha, registros]) =>
                registros.map(registro => [
                    registro.fecha,
                    registro.hora,
                    registro.motivo,
                    registro.excarceladosH,
                    registro.excarceladosM,
                    registro.presentesH,
                    registro.presentesM,
                    registro.total
                ])
            );

            doc.autoTable({
                head: [['Fecha', 'Hora', 'Motivo', 'Excarcelados (H)', 'Excarcelados (M)', 'Presentes (H)', 'Presentes (M)', 'Total']],
                body: tableData,
            });

            const pdfBlob = doc.output('blob');
            subirPDFaDrive(pdfBlob, 'Registro_Completo.pdf');
        }

        document.addEventListener('DOMContentLoaded', () => {
            cargarApiGoogle(); // Cargar la API de Google Drive al cargar la página
        });
    </script>
</body>
</html>
